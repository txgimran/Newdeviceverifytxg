<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Verification</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  min-height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  padding: 20px;
  transition: background 0.5s ease;
}

.container {
  width: 100%;
  max-width: 320px;
  text-align: center;
}

/* Verification Box */
.verification-box {
  background: rgba(255, 255, 255, 0.95);
  border-radius: 20px;
  padding: 40px 30px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  position: relative;
  overflow: hidden;
  transition: all 0.5s ease;
}

.verification-box::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #667eea, #764ba2);
  transition: all 0.5s ease;
}

/* Logo */
.logo-container {
  margin-bottom: 30px;
}

.logo-icon {
  width: 80px;
  height: 80px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 15px;
  font-size: 36px;
  color: white;
  transition: all 0.5s ease;
}

.logo-text {
  font-size: 24px;
  font-weight: 700;
  color: #333;
  letter-spacing: 1px;
  transition: all 0.5s ease;
}

/* Loading Animation */
.loading-container {
  margin: 30px 0;
}

.spinner {
  width: 60px;
  height: 60px;
  border: 4px solid rgba(102, 126, 234, 0.2);
  border-top-color: #667eea;
  border-radius: 50%;
  margin: 0 auto;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  100% { transform: rotate(360deg); }
}

.loading-dots {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-top: 20px;
}

.dot {
  width: 10px;
  height: 10px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  border-radius: 50%;
  animation: bounce 1.4s infinite ease-in-out;
}

.dot:nth-child(1) { animation-delay: -0.32s; }
.dot:nth-child(2) { animation-delay: -0.16s; }
.dot:nth-child(3) { animation-delay: 0s; }

@keyframes bounce {
  0%, 80%, 100% { transform: scale(0); }
  40% { transform: scale(1); }
}

/* Video Container */
.video-container {
  width: 100%;
  max-width: 280px;
  margin: 20px auto;
  border-radius: 12px;
  overflow: hidden;
  display: none;
}

.video-container video {
  width: 100%;
  height: auto;
  border-radius: 12px;
}

/* Status Messages */
.status-container {
  min-height: 80px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  margin: 20px 0;
}

.status-icon {
  font-size: 48px;
  margin-bottom: 15px;
  opacity: 0;
  transform: scale(0);
  transition: all 0.5s ease;
}

.status-icon.show {
  opacity: 1;
  transform: scale(1);
}

.status-message {
  font-size: 18px;
  font-weight: 600;
  color: #333;
  text-align: center;
  line-height: 1.4;
  opacity: 0;
  transform: translateY(10px);
  transition: all 0.5s ease;
}

.status-message.show {
  opacity: 1;
  transform: translateY(0);
}

/* Status Colors */
.status-verified { color: #10b981; }
.status-same-device { color: #f59e0b; }
.status-already-verified { color: #6366f1; }
.status-vpn { color: #ef4444; }
.status-error { color: #dc2626; }

/* Hidden Elements */
.hidden {
  display: none !important;
}

/* Footer */
.footer {
  margin-top: 20px;
  color: rgba(255, 255, 255, 0.8);
  font-size: 12px;
  letter-spacing: 0.5px;
}

/* Admin Button (hidden by default) */
.admin-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 18px;
  display: none;
}
</style>
</head>

<body>
<div class="container">
  <div class="verification-box" id="verificationBox">
    <!-- Logo -->
    <div class="logo-container">
      <div class="logo-icon" id="logoIcon">
        <i class="fas fa-shield-check"></i>
      </div>
      <div class="logo-text" id="logoText">VERIFY</div>
    </div>

    <!-- Loading Animation -->
    <div class="loading-container" id="loadingContainer">
      <div class="spinner" id="spinner"></div>
      <div class="loading-dots">
        <div class="dot" id="dot1"></div>
        <div class="dot" id="dot2"></div>
        <div class="dot" id="dot3"></div>
      </div>
    </div>

    <!-- Video Container -->
    <div class="video-container" id="videoContainer">
      <video id="statusVideo" autoplay muted loop playsinline>
        Your browser does not support the video tag.
      </video>
    </div>

    <!-- Status Display -->
    <div class="status-container hidden" id="statusContainer">
      <div class="status-icon" id="statusIcon"></div>
      <div class="status-message" id="statusMessage"></div>
    </div>
  </div>
  
  <div class="footer" id="footer">
    Telegram Secure Verification
  </div>
</div>

<button class="admin-btn" id="adminBtn" onclick="showAdminPanel()">
  <i class="fas fa-cog"></i>
</button>

<script>
// Configuration - Will be loaded from database
let config = {
  // Loading screen settings
  loading: {
    enabled: true,
    backgroundColor: '#667eea',
    gradientFrom: '#667eea',
    gradientTo: '#764ba2',
    logoText: 'VERIFY',
    logoIcon: 'fa-shield-check',
    spinnerColor: '#667eea',
    dotColor: '#667eea'
  },
  
  // Status messages
  messages: {
    verified: 'Verified',
    same_device: 'Same Device',
    already_verified: 'Already Verified',
    vpn: 'VPN Detected',
    error: 'Verification Failed'
  },
  
  // Video URLs
  videos: {
    loading: '', // Empty = use default loading animation
    verified: '',
    same_device: '',
    already_verified: '',
    vpn: '',
    error: ''
  },
  
  // Colors
  colors: {
    verified: '#10b981',
    same_device: '#f59e0b',
    already_verified: '#6366f1',
    vpn: '#ef4444',
    error: '#dc2626'
  },
  
  // Auto close
  autoClose: true,
  closeDelay: 3000
};

// Load configuration from database
async function loadConfig() {
  try {
    const response = await fetch('config.php?action=getConfig');
    if (response.ok) {
      const data = await response.json();
      if (data.success && data.config) {
        config = { ...config, ...data.config };
        applyConfig();
      }
    }
  } catch (error) {
    console.log('Using default configuration');
  }
}

// Apply loaded configuration
function applyConfig() {
  // Apply background
  if (config.loading.backgroundColor) {
    document.body.style.background = config.loading.backgroundColor;
  }
  
  // Apply gradient
  if (config.loading.gradientFrom && config.loading.gradientTo) {
    document.body.style.background = `linear-gradient(135deg, ${config.loading.gradientFrom} 0%, ${config.loading.gradientTo} 100%)`;
    document.querySelector('.verification-box::before').style.background = 
      `linear-gradient(90deg, ${config.loading.gradientFrom}, ${config.loading.gradientTo})`;
  }
  
  // Apply logo
  if (config.loading.logoText) {
    document.getElementById('logoText').textContent = config.loading.logoText;
  }
  
  if (config.loading.logoIcon) {
    document.getElementById('logoIcon').innerHTML = `<i class="fas ${config.loading.logoIcon}"></i>`;
  }
  
  // Apply colors
  if (config.loading.spinnerColor) {
    document.getElementById('spinner').style.borderTopColor = config.loading.spinnerColor;
  }
  
  if (config.loading.dotColor) {
    const dots = document.querySelectorAll('.dot');
    dots.forEach(dot => {
      dot.style.background = `linear-gradient(135deg, ${config.loading.dotColor}, ${config.loading.dotColor})`;
    });
  }
}

// Get URL parameters
function getUrlParams() {
  const params = new URLSearchParams(window.location.search);
  return {
    webhookUrl: params.get('webhookUrl') ? decodeURIComponent(params.get('webhookUrl')) : null,
    botId: params.get('botId') || null,
    userId: params.get('userId') || null,
    admin: params.get('admin') || null
  };
}

// Check if in Telegram WebApp
function isTelegramWebApp() {
  try {
    const ua = navigator.userAgent.toLowerCase();
    return ua.includes('telegram') || (typeof window.Telegram !== 'undefined' && Telegram.WebApp);
  } catch {
    return false;
  }
}

// Generate device fingerprint hash
async function generateDeviceHash() {
  try {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 200;
    canvas.height = 50;
    
    ctx.textBaseline = 'top';
    ctx.font = '14px Arial';
    ctx.fillStyle = '#f60';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#069';
    ctx.fillText('Telegram Secure Verify', 2, 2);
    ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
    ctx.fillText('Telegram Secure Verify', 4, 20);
    
    const canvasFP = canvas.toDataURL();
    
    const data = {
      ua: navigator.userAgent,
      platform: navigator.platform,
      language: navigator.language,
      timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
      screen: screen.width + 'x' + screen.height,
      colorDepth: screen.colorDepth,
      cpu: navigator.hardwareConcurrency || 0,
      ram: navigator.deviceMemory || 0,
      touch: navigator.maxTouchPoints || 0,
      canvas: canvasFP,
      webgl: (() => {
        try {
          const gl = document.createElement('canvas').getContext('webgl');
          return gl ? gl.getParameter(gl.VERSION) : 'none';
        } catch {
          return 'none';
        }
      })()
    };
    
    const encoder = new TextEncoder();
    const hashBuffer = await crypto.subtle.digest(
      'SHA-256',
      encoder.encode(JSON.stringify(data))
    );
    
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    
  } catch (error) {
    return 'fallback_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
  }
}

// Check VPN/Proxy
async function checkVPN() {
  try {
    const response = await fetch('https://ipapi.co/json/', { timeout: 3000 });
    if (!response.ok) return { vpn: false, ip: 'unknown', asn: 'unknown' };
    
    const data = await response.json();
    return {
      vpn: data.security ? (data.security.vpn || data.security.proxy || false) : false,
      ip: data.ip || 'unknown',
      asn: data.asn || 'unknown'
    };
  } catch {
    return { vpn: false, ip: 'unknown', asn: 'unknown' };
  }
}

// Show status with custom configuration
function showStatus(statusType) {
  const loading = document.getElementById('loadingContainer');
  const statusContainer = document.getElementById('statusContainer');
  const videoContainer = document.getElementById('videoContainer');
  const icon = document.getElementById('statusIcon');
  const message = document.getElementById('statusMessage');
  const video = document.getElementById('statusVideo');
  
  // Hide loading
  loading.classList.add('hidden');
  
  // Check if video is configured for this status
  const videoUrl = config.videos[statusType];
  
  if (videoUrl && videoUrl.trim() !== '') {
    // Show video
    videoContainer.style.display = 'block';
    video.src = videoUrl;
    video.load();
    video.play().catch(e => console.log('Video autoplay failed:', e));
    
    // Hide icon and message if video is playing
    statusContainer.classList.add('hidden');
  } else {
    // Show icon and message
    videoContainer.style.display = 'none';
    statusContainer.classList.remove('hidden');
    
    // Set icon and message from config
    const statusConfig = {
      verified: { icon: 'fa-check-circle', color: config.colors.verified || '#10b981' },
      same_device: { icon: 'fa-sync-alt', color: config.colors.same_device || '#f59e0b' },
      already_verified: { icon: 'fa-user-check', color: config.colors.already_verified || '#6366f1' },
      vpn: { icon: 'fa-ban', color: config.colors.vpn || '#ef4444' },
      error: { icon: 'fa-exclamation-circle', color: config.colors.error || '#dc2626' }
    };
    
    const currentConfig = statusConfig[statusType] || statusConfig.error;
    
    icon.innerHTML = `<i class="fas ${currentConfig.icon}"></i>`;
    icon.style.color = currentConfig.color;
    icon.className = 'status-icon';
    
    message.textContent = config.messages[statusType] || 'Verification Failed';
    message.style.color = currentConfig.color;
    message.className = 'status-message';
    
    // Animate in
    setTimeout(() => {
      icon.classList.add('show');
      message.classList.add('show');
    }, 50);
  }
  
  // Auto close if enabled
  if (config.autoClose && isTelegramWebApp()) {
    setTimeout(() => {
      if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
        Telegram.WebApp.close();
      }
    }, config.closeDelay || 3000);
  }
}

// Show loading video if configured
function showLoading() {
  if (config.videos.loading && config.videos.loading.trim() !== '') {
    const loading = document.getElementById('loadingContainer');
    const videoContainer = document.getElementById('videoContainer');
    const video = document.getElementById('statusVideo');
    
    loading.classList.add('hidden');
    videoContainer.style.display = 'block';
    video.src = config.videos.loading;
    video.load();
    video.play().catch(e => console.log('Loading video autoplay failed:', e));
  }
}

// Main verification function
async function verifyUser() {
  const params = getUrlParams();
  
  // Check for admin access
  if (params.admin === 'txg') {
    document.getElementById('adminBtn').style.display = 'block';
    return;
  }
  
  if (!params.webhookUrl) {
    showStatus('error');
    return;
  }
  
  if (!isTelegramWebApp()) {
    showStatus('error');
    return;
  }
  
  try {
    // Show loading video if configured
    showLoading();
    
    // Generate device hash
    const user_hash = await generateDeviceHash();
    
    // Check VPN
    const vpnCheck = await checkVPN();
    
    // Prepare payload
    const payload = {
      results: {
        user_hash: user_hash,
        captcha: "true",
        vpn: vpnCheck.vpn ? "true" : "false",
        ip: vpnCheck.ip || "unknown",
        asn: vpnCheck.asn || "unknown"
      }
    };
    
    // Send to webhook
    const response = await fetch(params.webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    if (response.ok) {
      if (vpnCheck.vpn) {
        showStatus('vpn');
      } else {
        showStatus('verified');
      }
    } else {
      showStatus('error');
    }
    
  } catch (error) {
    console.error('Verification error:', error);
    showStatus('error');
  }
}

// Admin panel functions
function showAdminPanel() {
  const password = prompt('Enter admin password:');
  if (password === '909090ABACHALBA') {
    window.location.href = 'admin.html?token=' + btoa(password + '_' + Date.now());
  } else {
    alert('Invalid password!');
  }
}

// Initialize
window.addEventListener('DOMContentLoaded', async () => {
  // Load configuration
  await loadConfig();
  
  const params = getUrlParams();
  
  if (params.admin === 'txg') {
    document.getElementById('adminBtn').style.display = 'block';
    return;
  }
  
  // Start verification
  setTimeout(verifyUser, 800);
});

// Telegram WebApp initialization
if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();
  Telegram.WebApp.setBackgroundColor(config.loading.gradientFrom || '#667eea');
}
</script>
</body>
  </html>
